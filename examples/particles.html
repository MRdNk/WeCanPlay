<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>WebCanPlay - Particles</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="author" content="Wecanplay">
    
    <link href="ressources/style/bootstrap.min.css" rel="stylesheet">
    <link href="ressources/style/wecanplay.css" rel="stylesheet">

    <script src="build-WCP.js"></script>
</head>
<body>
    <nav class="navbar navbar-fixed-top">
      <div class="navbar-inner">
        <div class="container">
            <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </a>
            <a class="brand" href="http://www.wecanplay.fr/"><img src="ressources/style/logo_wecanplay.png" width="50" />WeCanPlay</a>
            <div class="nav-collapse">
            <ul class="nav">
                <li><a href="#">Particles</a></li>
            </ul>
            </div><!--/.nav-collapse -->
        </div>
      </div>
    </nav>

    
    <div class="container">
        <div class="jumbotron subhead">
            <h1>Particles Attraction</h1>
            <p class="subtitle">Example TXT</p>
            <div class='row'>
                <div class='span5'>
                    <div class="btn-group">
                        <button class="btn" id="add5">+ 5 balls</button>
                        <button class="btn" id="add10">+ 10 balls</button>
                        <button class="btn" id="add25">+ 25 balls</button>
                        <button class="btn" id="add50">+ 50 balls</button>
                    </div>
                </div>
                <div class='span2'>
                    FPS <span id="infos-fps" class='badge badge-success'>-</span>
                </div>
                <div class='span2'>
                    Balls count <span id="infos-balls" class='badge badge-info'>-</span>
                </div>
            </div>
            <canvas id="canvas" style="background: black;"></canvas>
            <div class='well'>
                This demo allows you to test the performance by displaying a large number of sprite.
                We use one image to which we applied a filter for a different color.
                Mouvement are calculated with vetors function offered by WCP.
            </div>
       </div>
   </div>
<script>

function findPos(obj) {
    var curleft = curtop = 0;
    
    if (obj.offsetParent) {
        do {
            curleft += obj.offsetLeft;
            curtop += obj.offsetTop;
        } while (obj = obj.offsetParent);
    }

    return {x: curleft, y: curtop};
}

var coloredBalls = [];
var numBalls = 0;
var attractionPoint = 'fixed';
var attractionCoordsDefault = {x: 300, y: 300};
var attractionCoords = {x: 0, y: 0};


var attractionPower = 5000;
var speedDecrease = 0.7;

var canvas = document.getElementById('canvas');

canvas.addEventListener('mouseover', function(e) {
});

canvas.addEventListener('mouseout', function() {
    attractionCoords = attractionCoordsDefault;
});

canvas.addEventListener('mousemove', function(e) {
    var p = findPos(canvas);

    attractionCoords = {
        x: e.pageX - p.x,
        y: e.pageY - p.y
    };
});

function Ball() {
    this.sprite = new WCP.Sprite(coloredBalls[WCP.random(0, coloredBalls.length - 1)]);
    this.sprite.setOrigin(WCP.Sprite.ORIGIN_CENTER);
    this.scale = WCP.random(3, 5) / 100;
    this.mass = this.scale * 10;

    this.sprite.width *= this.scale;
    this.sprite.height *= this.scale;

    this.sprite.x = (WCP.width - this.sprite.width) / 2;
    this.sprite.y = (WCP.height - this.sprite.height) / 2;

    // Random angle between [0, 2 * PI]
    this.angle = Math.PI * 2 * Math.random();

    // speed
    var v = WCP.random(200, 400);
    this.vx = v * Math.cos(this.angle);
    this.vy = v * Math.sin(this.angle);

    this.id = listBalls.length;
    numBalls++;

    listBalls.push(this);
}

Ball.prototype.update = function (elapsed) {
    elapsed = elapsed / 1000; // in Seconds

    // attraction
    var point = attractionCoords;
    var attrVector = new WCP.Vector(this.sprite.x, this.sprite.y, point.x, point.y);

    attrVector = attrVector.normalize().mult(attractionPower * elapsed);

    this.vx += attrVector.x;
    this.vy += attrVector.y;

    this.vx *= 1 - (speedDecrease * elapsed);
    this.vy *= 1 - (speedDecrease * elapsed);

    // New position
    this.sprite.x += this.vx * elapsed;
    this.sprite.y += this.vy * elapsed;

    if (this.sprite.x < this.sprite.width / 2) {
        this.vx *= -1;
        this.sprite.x = this.sprite.width / 2;
    }

    if (this.sprite.y < this.sprite.height/2) {
        this.vy *= -1;
        this.sprite.y = this.sprite.height/2;
    }

    if (this.sprite.x > (WCP.width - this.sprite.width / 2)) {
        this.vx *= -1;
        this.sprite.x = WCP.width - this.sprite.width / 2;
    }

    if (this.sprite.y > (WCP.height - this.sprite.height / 2)) {
        this.vy *= -1;
        this.sprite.y = WCP.height - this.sprite.height / 2;
    }
}

var CAN_X = 935,
CAN_Y = 500;

WCP.setCanvas("canvas", CAN_X, CAN_Y);

WCP.Assets.add({
    path: './',
    assets: {
        'ball': 'ressources/soccer-ball.png'
    }
});

var logo;
var attrPoint = new WCP.Draw.Point(0, 0, 10, "#999999");

var mainView = new WCP.View({
    init: function () {
        
        maxBalls = 10;
        numBalls = 0;
        listBalls = [];

        var ball1 = new Ball();

        this.add(ball1.sprite);

        this.ballSpawningInt = WCP.setInterval(500, function () {
            if (numBalls < maxBalls) {
                WCP.add((new Ball()).sprite);
            } else {
                WCP.clearInterval(this.ballSpawningInt);
            }
        });

        this.add(attrPoint);
        
    },
    loop: function () {
        var elapsed = this.elapsed();

        for (var i = 0; i < listBalls.length; i++) {
            if (listBalls[i]) {
                listBalls[i].update(elapsed);
            }
        }

        attrPoint.x = attractionCoords.x;
        attrPoint.y = attractionCoords.y;
    },
    draw: function() {
    }
});

function addBalls(n) {
    if (mainView.active) {
        for (var i = 0; i < n; i++) {
            mainView.add((new Ball()).sprite);
        }
    }
}

/*
 * INIT
 */
WCP.Assets.load('*', null, function(){
    WCP.setFps(60);

    // colore all the balls
    var colors = {
        red:        [0x22, 0x00, 0x00],
        green:      [0x00, 0x88, 0x00],
        blue:       [0x00, 0x00, 0x66],
        lightblue:  [0x33, 0x33, 0xBB],
        purple:     [0x88, 0x00, 0x88],
        orange:     [0xAA, 0x44, 0x00],
        yellow:     [0xAA, 0xAA, 0x00]
    };

    for (var colorName in colors) {
        coloredBalls.push(WCP.Filter.colorAdjust(WCP.Assets.get('ball'), colors[colorName]));
    }

    mainView.start();
});

setInterval(function () {
    document.getElementById('infos-fps').innerHTML = Math.round(WCP.getRealFps());
    document.getElementById('infos-balls').innerHTML = numBalls;
}, 250);

document.getElementById('add5').addEventListener('click', function() {
    addBalls(5);
});
document.getElementById('add10').addEventListener('click', function() {
    addBalls(10);
});
document.getElementById('add25').addEventListener('click', function() {
    addBalls(25);
});
document.getElementById('add50').addEventListener('click', function() {
    addBalls(50);
});



</script>
</body>
</html>